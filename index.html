<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AccessMap - Inspired by StopGap</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        body, html { height: 100%; margin: 0; overflow: hidden; }
        #map { height: 100%; width: 100%; z-index: 0; }

        /* Popup Styling */
        .leaflet-popup-content-wrapper {
            border-radius: 0.75rem;
            padding: 0;
            overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .leaflet-popup-content { margin: 0; width: 240px !important; }
        .leaflet-popup-tip { background: white; }

        /* Pin Styling */
        .custom-pin { background: none; border: none; }
        .pin-marker {
            -webkit-text-stroke: 2px white;
            paint-order: stroke fill;
            filter: drop-shadow(0 4px 6px rgb(0 0 0 / 0.4));
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .pin-marker:hover { transform: scale(1.2) translateY(-8px); }

        /* Control Overrides */
        .leaflet-control-layers {
            border: none !important;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1) !important;
            border-radius: 0.75rem !important;
            font-family: ui-sans-serif, system-ui, sans-serif !important;
            padding: 4px !important;
            overflow: visible !important;
            min-width: unset !important;
        }

        .leaflet-control-layers-toggle {
            width: auto !important;
            height: 40px !important;
            background-size: 20px !important;
            background-position: 10px center !important;
            padding-left: 38px !important;
            padding-right: 12px !important;
            background-color: white !important;
            border-radius: 8px !important;
            display: flex !important;
            align-items: center !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1) !important;
            border: 2px solid rgba(0,0,0,0.1) !important;
        }

        .leaflet-control-layers-toggle::after {
            content: "Map Style";
            position: static !important;
            transform: none !important;
            background: none !important;
            padding: 0 !important;
            margin: 0 !important;
            box-shadow: none !important;
            border: none !important;
            font-size: 13px !important;
            font-weight: 700 !important;
            color: #334155 !important;
        }

        .leaflet-control-layers-expanded {
            padding: 12px !important;
            min-width: 150px !important;
        }

        .leaflet-control-layers-expanded .leaflet-control-layers-toggle { display: none !important; }
        .leaflet-control-layers label {
            display: flex !important;
            align-items: center !important;
            margin-bottom: 8px !important;
            cursor: pointer !important;
            padding: 4px 0;
        }
        .leaflet-control-layers label:last-child { margin-bottom: 0 !important; }
        .leaflet-control-layers-selector {
            transform: scale(1.3);
            margin-right: 10px !important;
            margin-top: 0 !important;
            accent-color: #dc2626;
            cursor: pointer !important;
        }

        /* RESPONSIVE CONTROL POSITIONING */
        /* Desktop Default */
        .leaflet-top.leaflet-right {
            margin-top: 80px;
            transition: margin-top 0.3s ease;
        }

        /* Mobile Adjustment: Increased to 320px to safely clear stacked controls & search results */
        @media (max-width: 768px) {
            .leaflet-top.leaflet-right {
                margin-top: 320px !important;
            }
        }

        /* Focus outline for accessibility */
        *:focus-visible {
            outline: 2px solid #2563eb;
            outline-offset: 2px;
        }

        /* Custom scrollbar for modal */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-gray-100 font-sans text-slate-800">

    <!-- Top Navigation Bar -->
    <header class="absolute top-0 left-0 right-0 z-[1000] bg-white/95 backdrop-blur-md shadow-md px-4 py-3 flex flex-wrap justify-between items-center border-b border-gray-200 gap-y-2">
        <div class="flex items-center gap-3">
            <img src="https://accessibleicon.org/img/accessible-icon.jpg" alt="AccessMap Logo" class="h-10 w-10 rounded-md shadow-sm object-cover" aria-hidden="true">
            <div>
                <h1 class="font-bold text-lg text-slate-900 tracking-tight leading-none">AccessMap</h1>
                <p class="text-[10px] text-slate-500 font-bold tracking-wide uppercase">Community Accessibility Project</p>
            </div>
        </div>

        <!-- Buttons Wrapper: Use flex-wrap to allow stacking on very narrow screens, otherwise side-by-side -->
        <div class="flex flex-wrap items-center gap-2 w-full sm:w-auto justify-end mt-2 sm:mt-0">
            <button id="helpBtn" onclick="openHelpModal()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-full text-xs font-bold transition-colors shadow-sm flex items-center gap-1 flex-1 sm:flex-none justify-center min-w-fit">
                <i class="ph-bold ph-hand-heart" aria-hidden="true"></i>
                <span class="whitespace-nowrap">How to Use</span>
            </button>
            <button id="aboutBtn" onclick="openAboutModal()" class="bg-slate-900 hover:bg-slate-700 text-white px-3 py-1.5 rounded-full text-xs font-bold transition-colors shadow-sm flex items-center gap-1 flex-1 sm:flex-none justify-center min-w-fit">
                <i class="ph-bold ph-info" aria-hidden="true"></i>
                <span class="whitespace-nowrap">Inspired by StopGap - Learn More</span>
            </button>
        </div>
    </header>

    <!-- NEW: Organized Top Left Controls (Search & Filter & Find Me) -->
    <!-- Adjusted Top position for mobile to account for potentially taller header (approx 130px if wrapped) -->
    <div class="absolute top-[140px] left-2 right-12 md:top-[80px] md:left-4 md:right-auto md:w-full md:max-w-sm z-[1000] flex flex-col gap-3 transition-all duration-300">

        <!-- Row 1: Search Bar + Find Me Button -->
        <div class="flex gap-2 w-full h-11 items-center">
            <!-- Search Bar -->
            <div class="relative group flex-1 h-full shadow-lg rounded-xl bg-white">
                <input type="text" id="searchInput" placeholder="Search address..."
                    class="w-full h-full pl-10 pr-12 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-red-500 text-sm font-medium transition-all"
                    onkeypress="handleSearchKey(event)">
                <i class="ph-bold ph-magnifying-glass absolute left-3.5 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-red-500 transition-colors"></i>

                <!-- NEW: Enter Button -->
                <button onclick="performSearch()" class="absolute right-1 top-1 bottom-1 aspect-square bg-slate-100 hover:bg-slate-200 text-slate-500 hover:text-red-600 rounded-lg transition-colors flex items-center justify-center border border-slate-200" title="Search">
                    <i class="ph-bold ph-arrow-right text-lg"></i>
                </button>
            </div>

            <!-- Find Me Button -->
            <button onclick="locateUser()" class="h-full bg-white hover:bg-slate-50 text-slate-700 px-4 rounded-xl shadow-lg border border-slate-200 transition-all hover:scale-105 group flex items-center justify-center gap-2 whitespace-nowrap" title="Find My Location">
                <i class="ph-bold ph-crosshair text-xl group-hover:text-red-600 transition-colors"></i>
                <span class="text-xs font-bold text-slate-600 group-hover:text-slate-900 hidden md:inline">Find Me</span>
            </button>
        </div>

        <!-- Row 2: Filter Controls -->
        <div class="bg-white/95 backdrop-blur rounded-xl shadow-lg border border-slate-200 p-2 w-full">
            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 block px-1">Filter Pins</span>
            <div class="flex flex-wrap gap-1">
                <button onclick="setFilter('all')" id="filter-all" class="flex-1 px-3 py-1.5 rounded-lg text-xs font-bold bg-slate-900 text-white transition-colors text-center">All</button>
                <button onclick="setFilter('accessible')" id="filter-accessible" class="flex-1 px-3 py-1.5 rounded-lg text-xs font-bold text-slate-600 hover:bg-green-50 hover:text-green-600 transition-colors flex items-center justify-center gap-1">
                    <i class="ph-fill ph-check-circle"></i> <span class="hidden sm:inline">Accessible</span>
                </button>
                <button onclick="setFilter('inaccessible')" id="filter-inaccessible" class="flex-1 px-3 py-1.5 rounded-lg text-xs font-bold text-slate-600 hover:bg-red-50 hover:text-red-600 transition-colors flex items-center justify-center gap-1">
                    <i class="ph-fill ph-prohibit"></i> <span class="hidden sm:inline">Barrier</span>
                </button>
            </div>
        </div>

    </div>

    <!-- Map Container -->
    <main id="map" aria-label="Interactive map of accessible locations in Toronto"></main>

    <!-- NEW: Mobile-Only Find Me Button REMOVED (Consolidated into top search bar) -->

    <!-- Beyond Ramps Banner/Button -->
    <div class="absolute bottom-8 right-4 md:right-14 z-[1000] hidden md:block">
        <button onclick="openBeyondModal()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-full text-sm font-bold shadow-xl flex items-center gap-3 border-2 border-white transition-all transform hover:-translate-y-1 hover:scale-105">
            <i class="ph-bold ph-megaphone text-yellow-300 text-2xl"></i>
            <span class="drop-shadow-sm">Beyond ramps! We need to do more</span>
        </button>
    </div>
    <!-- Mobile version -->
    <div class="absolute bottom-24 right-4 z-[1000] md:hidden">
        <button onclick="openBeyondModal()" class="bg-red-600 hover:bg-red-700 text-white p-4 rounded-full shadow-xl border-2 border-white transition-transform hover:-translate-y-1" aria-label="Beyond ramps, read more">
            <i class="ph-bold ph-megaphone text-yellow-300 text-2xl"></i>
        </button>
    </div>

    <!-- Modals (Help, About, Beyond, Pin, Delete) remain largely same but preserved -->
    <!-- Modal 1: How to Use -->
    <div id="helpModal" role="dialog" aria-modal="true" aria-labelledby="helpTitle" class="hidden absolute inset-0 z-[2000] bg-slate-900/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md animate-fade-in overflow-hidden focus:outline-none" tabindex="-1">
            <div class="bg-red-600 p-5 text-white flex justify-between items-center">
                <h2 id="helpTitle" class="font-bold text-xl flex items-center gap-2"><i class="ph-bold ph-hand-heart text-2xl"></i> How to Use</h2>
                <button onclick="closeHelpModal()" class="hover:bg-white/20 rounded-full p-1 transition-colors"><i class="ph-bold ph-x text-xl"></i></button>
            </div>
            <div class="p-6">
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 space-y-4">
                    <p class="text-sm text-slate-700 leading-relaxed"><strong>Help your community navigate!</strong> By marking locations, you act as eyes and ears for neighbors who need access.</p>
                    <ul class="text-sm text-slate-600 space-y-3">
                        <li class="flex items-start gap-3"><div class="bg-green-100 p-1.5 rounded-full text-green-600 mt-0.5"><i class="ph-fill ph-check-circle"></i></div><div><strong class="text-slate-800">Accessible Entry</strong><br>Mark stores with no steps, or where a permanent ramp/automatic door exists.</div></li>
                        <li class="flex items-start gap-3"><div class="bg-red-100 p-1.5 rounded-full text-red-600 mt-0.5"><i class="ph-fill ph-prohibit"></i></div><div><strong class="text-slate-800">Needs Ramp / Barrier</strong><br>Mark stores with a single step entry or other barriers preventing access.</div></li>
                        <li class="flex items-start gap-3"><div class="bg-blue-100 p-1.5 rounded-full text-blue-600 mt-0.5"><i class="ph-fill ph-thumbs-up"></i></div><div><strong class="text-slate-800">Verify Accuracy</strong><br>Use <strong>Thumb Up</strong> to confirm info is correct, or <strong>Thumb Down</strong> if it's outdated or wrong.</div></li>
                    </ul>
                    <!-- Features Instructions -->
                    <div class="pt-3 border-t border-slate-200">
                        <h3 class="text-xs font-bold text-slate-500 uppercase mb-3">Features</h3>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="flex items-center gap-2 text-xs font-semibold text-slate-600 bg-white border border-slate-200 px-2 py-1.5 rounded"><i class="ph-bold ph-magnifying-glass text-red-500"></i> Search Address</div>
                            <div class="flex items-center gap-2 text-xs font-semibold text-slate-600 bg-white border border-slate-200 px-2 py-1.5 rounded"><i class="ph-bold ph-funnel text-red-500"></i> Filter Pins</div>
                            <div class="flex items-center gap-2 text-xs font-semibold text-slate-600 bg-white border border-slate-200 px-2 py-1.5 rounded"><i class="ph-bold ph-crosshair text-red-500"></i> Find Location</div>
                            <div class="flex items-center gap-2 text-xs font-semibold text-slate-600 bg-white border border-slate-200 px-2 py-1.5 rounded"><i class="ph-bold ph-microphone text-red-500"></i> Voice Entry</div>
                        </div>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-slate-100">
                    <h3 class="text-xs font-bold text-slate-500 uppercase mb-3">Take Further Action</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="closeHelpModal(); openBeyondModal()" class="flex flex-col items-center justify-center p-3 bg-slate-50 hover:bg-slate-100 border border-slate-200 rounded-lg transition-colors text-center group w-full"><i class="ph-fill ph-megaphone text-2xl text-slate-400 group-hover:text-slate-600 mb-1"></i><span class="text-xs font-bold text-slate-700">Advocate for Change</span></button>
                        <a href="https://stopgap.ca/donate/" target="_blank" class="flex flex-col items-center justify-center p-3 bg-red-50 hover:bg-red-100 border border-red-100 rounded-lg transition-colors text-center group"><i class="ph-fill ph-heart text-2xl text-red-400 group-hover:text-red-600 mb-1"></i><span class="text-xs font-bold text-red-700">Donate to StopGap</span></a>
                    </div>
                </div>
                <div class="mt-6 text-center"><button onclick="closeHelpModal()" class="w-full px-4 py-2.5 text-sm font-bold text-white bg-slate-900 rounded-lg hover:bg-slate-800 transition-colors">Got it, I'm ready to map!</button></div>
            </div>
        </div>
    </div>

    <!-- Modal 2: About StopGap -->
    <div id="aboutModal" role="dialog" aria-modal="true" aria-labelledby="aboutTitle" class="hidden absolute inset-0 z-[2000] bg-slate-900/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg animate-fade-in overflow-hidden focus:outline-none flex flex-col max-h-[90vh]" tabindex="-1">
            <div class="bg-slate-900 p-6 text-white text-center shrink-0 relative overflow-hidden">
                <div class="absolute inset-0 opacity-10 bg-[url('https://yt3.googleusercontent.com/ytc/AIdro_kA0PKl6ehUqajQzOllbm1p6yDOeNeWxN-u3CVVx2uGiA=s900-c-k-c0x00ffffff-no-rj')] bg-center bg-cover"></div>
                <div class="relative z-10">
                    <img src="https://yt3.googleusercontent.com/ytc/AIdro_kA0PKl6ehUqajQzOllbm1p6yDOeNeWxN-u3CVVx2uGiA=s900-c-k-c0x00ffffff-no-rj" alt="StopGap Foundation Logo" class="h-16 w-16 mx-auto rounded-full border-4 border-white/20 mb-3 shadow-lg">
                    <h2 id="aboutTitle" class="font-bold text-2xl">Why We Love StopGap</h2>
                    <p class="text-slate-400 text-sm mt-1">Inspired by the movement to build a barrier-free world.</p>
                </div>
            </div>
            <div class="p-6 space-y-6 overflow-y-auto custom-scroll text-slate-700 leading-relaxed text-sm">
                <!-- Content preserved -->
                <section><h3 class="text-red-600 font-bold text-lg mb-2">The Problem with One Step</h3><p>Think about your favorite local place—that corner café or bookstore you visit all the time. Now imagine walking up to the door and hitting a block. It’s not a big metal gate; it’s just a single, small step.</p><p class="mt-2">For most people, that step is totally fine. But for thousands of people in Canada using a wheelchair, a stroller, or a walker, that few inches of concrete is a complete barrier. It’s a message that says: <strong>You aren’t supposed to be here.</strong></p><p class="mt-2">The <strong>StopGap Foundation</strong> is an organization that refuses to let that message stick. They are taking simple barriers and transforming them into bright, loud, and temporary solutions. Through these colorful, community-built ramps, StopGap is pushing us to look closer at exclusion and imagine a world where everyone can easily get inside.</p></section>
                <img src="https://stopgap.ca/wp-content/uploads/2017/04/DSC_5518.jpg" alt="StopGap team building ramps" class="w-full h-48 object-cover rounded-xl shadow-md">
                <section><h3 class="text-red-600 font-bold text-lg mb-2">What is StopGap?</h3><p>Founded in Toronto by <strong>Luke Anderson</strong>, the StopGap Foundation is a grassroots movement that builds custom wooden ramps for single-step storefronts. You’ve probably seen them—they are usually painted in bright reds, blues, greens, and yellows that are impossible to miss.</p><p class="mt-2">But here’s the cool part: the ramps aren’t meant to be permanent fixes. StopGap is clear that the wooden ramps are only a temporary fix. The main goal is to spark conversations, pushing business owners, neighbors, and local leaders to ask why our world is built with these barriers in the first place.</p><p class="mt-2">StopGap volunteers team up with local businesses and schools to identify barriers and build these ramps together. Their Community Ramp Projects prove that accessibility isn't just a building code issue; it’s a community love language. When we build for access, we build a better space for everyone.</p></section>
                <img src="https://i.imgur.com/IGveADa.png" alt="A bright red StopGap ramp on a city street" class="w-full h-48 object-cover rounded-xl shadow-md grayscale hover:grayscale-0 transition-all duration-500">
                <section><h3 class="text-red-600 font-bold text-lg mb-2">Why This Matters</h3><p class="mb-3">You might be thinking, "It's just a ramp, right?" Actually, it connects to some huge ideas about justice and power.</p><ul class="space-y-4 list-decimal pl-4"><li><strong>Buildings Tell Us Who's Welcome:</strong> In many ways, the architecture all around us is an argument. When a bank or a café is designed with stairs but no ramp, the building is silently arguing that certain bodies are less important or less welcome. Disability justice advocates point out that our physical spaces communicate who belongs. StopGap's ramps are a public counter-argument. They disrupt that exclusion and use design to teach inclusion, proving that we can choose to build for everyone.</li><li><strong>Resisting Exclusion:</strong> The issue of access goes beyond just ramps; it’s about ensuring that people aren't pushed out—or dis-located—from public life. When disabled people can't enter shared community spaces, it reinforces a harmful separation. StopGap resists this by ensuring disabled people are visible and present in the daily life of the neighborhood. Their work fights against the systems that keep marginalized people—especially those facing ableism layered with racism—out of sight and out of mind.</li><li><strong>Small Acts, Big Change:</strong> Change doesn't always start with massive laws or protests. Sometimes, it starts with small, localized action. Each ramp StopGap installs is an act of small, joyful resistance that transforms an everyday hurdle into a public lesson on accessibility and care. They show us that by working together, we can get our resistance in wherever we can, making the world more inclusive one colorful step at a time.</li></ul></section>
                <section><h3 class="text-red-600 font-bold text-lg mb-2">Join the Movement</h3><p>StopGap shows us that you don't have to wait for the government to solve everything. Real change starts right here with a little lumber, a bright can of paint, and people ready to chip in.</p><p class="mt-2">There's a spot for everyone in this movement: volunteer to build ramps, donate materials, or simply start pointing out barriers in your own neighborhood. Because accessibility isn't just a design problem—it’s a demand for justice. Let's follow StopGap’s example and build a world where no one gets stopped at the door.</p></section>
                <div class="space-y-4"><img src="https://bloximages.chicago2.vip.townnews.com/thestar.com/content/tncms/assets/v3/editorial/7/7b/77b54934-cf8e-5a8b-a156-00cac7c48255/63ea32c2f1925.image.jpg" alt="Luke Anderson" class="w-full h-auto rounded-xl shadow-md object-top"><div class="bg-red-50 p-4 rounded-xl border-l-4 border-red-500 italic text-slate-600">“It's not us that have disabilities, but it's the places we live, work and play that are disabled” <br><span class="text-xs font-bold not-italic text-red-600 mt-1 block">— Luke Anderson, Founder of StopGap</span></div></div>
            </div>
            <div class="p-4 border-t border-gray-100 bg-gray-50 flex gap-3 shrink-0">
                <button onclick="closeAboutModal()" class="flex-1 px-4 py-2.5 text-sm font-bold text-slate-600 bg-white border border-gray-200 rounded-lg hover:bg-gray-100 transition-colors">Close</button>
                <a href="https://stopgap.ca/" target="_blank" class="flex-1 text-center px-4 py-2.5 text-sm font-bold text-white bg-red-600 rounded-lg hover:bg-red-700 shadow-lg shadow-red-500/30 transition-all">Visit StopGap.ca</a>
            </div>
        </div>
    </div>

    <!-- Modal 3: Beyond Ramps -->
    <div id="beyondModal" role="dialog" aria-modal="true" aria-labelledby="beyondTitle" class="hidden absolute inset-0 z-[2000] bg-slate-900/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg animate-fade-in overflow-hidden focus:outline-none flex flex-col max-h-[90vh]" tabindex="-1">
            <div class="bg-yellow-400 p-6 text-slate-900 flex justify-between items-start">
                <div><h2 id="beyondTitle" class="font-bold text-xl flex items-center gap-2"><i class="ph-bold ph-warning-circle text-2xl"></i> Risk of Normalizing</h2><p class="text-slate-800 text-sm mt-1 font-medium opacity-90">Why temporary ramps aren't enough.</p></div>
                <button onclick="closeBeyondModal()" class="hover:bg-white/20 rounded-full p-1 transition-colors"><i class="ph-bold ph-x text-xl"></i></button>
            </div>
            <div class="p-6 space-y-6 overflow-y-auto custom-scroll text-slate-700 leading-relaxed text-sm">
                <section><h3 class="font-bold text-slate-900 mb-2">Temporary Ramps and the Risk of Normalizing Stopgap Solutions</h3><p>Temporary ramps like StopGap’s are often celebrated because they immediately shift what is possible for many disabled people. They make a barrier suddenly crossable, and for a moment there is relief. But when a brightly painted ramp solves the problem for today, we also have to ask whether we unintentionally confirm the idea that disabled people should adapt to an inaccessible world rather than expect that world to change. This is where the risk of normalizing a stopgap emerges. It is not because the ramps themselves are harmful, but because institutions may seize on the appearance of progress while avoiding the harder, slower work of restructuring the built environment at its foundations.</p></section>
                <section><div class="bg-slate-50 p-4 rounded-xl border-l-4 border-yellow-400 italic text-slate-600 my-2">"Society gets trained to see access as an optional accommodation rather than a collective responsibility."</div><p>To deepen this point, disability scholar <strong>Nirmala Erevelles</strong>, whose work examines how institutions normalize exclusion, helps us understand why this matters. Erevelles reminds us that institutions often rely on “normalizing texts” that make structural exclusion seem natural and inevitable. In her work on curriculum and disability, she argues that society gets trained to see access as an optional accommodation rather than a collective responsibility. This insight helps us recognise why temporary ramps, while helpful, must not become the new normal. Temporary ramps can easily become part of this same pedagogical landscape. They teach the public that disability access is an add-on instead of a right, placing responsibility for inclusion on volunteer labour and charitable sentiment rather than on the state, property owners, or planners. Over time, the extraordinary becomes ordinary, and the deeper political demand becomes easier to ignore.</p></section>
                <section><h3 class="font-bold text-slate-900 mb-2">From Ramps to Resistance</h3><p>At the same time, StopGap’s ramps spark conversations. They interrupt the invisibility of stepped entrances and encourage bystanders to reflect on why a single step exists at all. Many disabled activists use these ramps not as an endpoint but as a way of making structural neglect impossible to look away from. The ramps are temporary, but the critique they invite is lasting. The challenge is to ensure they remain invitations to imagine a different built world, not excuses for the one we have.</p>
                <p class="mt-3">This is exactly where our accessibility map becomes a tool for action. By making thousands of stepped storefronts visible at once, the map turns an everyday inconvenience into undeniable evidence of a systemic problem. People can use it to contact their city councillor, write to their MP or MPP, speak at local Business Improvement Area meetings, or advocate for municipal funding that supports permanent renovations rather than volunteer-led fixes. Our map gives people something concrete to point to. It turns individual barriers into collective proof, and that proof can fuel pressure for real, lasting change.</p>
                </section>
                <div class="bg-red-50 p-5 rounded-xl border border-red-100 mt-4 shadow-sm"><h3 class="font-bold text-red-700 mb-4 flex items-center gap-2 text-lg"><i class="ph-bold ph-gavel"></i> Demand Systemic Change</h3><div class="space-y-4"><div class="grid gap-3"><a href="https://www.toronto.ca/city-government/council/members-of-council/" target="_blank" class="flex items-center justify-between p-3 bg-white rounded-lg border border-red-200 hover:border-red-400 hover:shadow-md transition-all group"><div class="flex items-center gap-3"><div class="bg-slate-100 p-2 rounded-full"><i class="ph-fill ph-buildings text-slate-600"></i></div><span class="text-sm font-bold text-slate-800">Find Your City Councillor</span></div><i class="ph-bold ph-arrow-right text-red-400 group-hover:text-red-600"></i></a><a href="https://www.ola.org/en/members" target="_blank" class="flex items-center justify-between p-3 bg-white rounded-lg border border-red-200 hover:border-red-400 hover:shadow-md transition-all group"><div class="flex items-center gap-3"><div class="bg-slate-100 p-2 rounded-full"><i class="ph-fill ph-map-trifold text-slate-600"></i></div><span class="text-sm font-bold text-slate-800">Find Your MPP (Provincial)</span></div><i class="ph-bold ph-arrow-right text-red-400 group-hover:text-red-600"></i></a></div><div class="pt-2 border-t border-red-200"><h4 class="font-bold text-sm text-slate-800 mb-2">Talk to Local Businesses</h4><p class="text-xs text-slate-600 mb-2">Next time you encounter a barrier, politely ask to speak to the manager or owner:</p><div class="bg-white p-3 rounded-lg border border-slate-200 text-xs italic text-slate-600 relative"><i class="ph-fill ph-quotes text-red-200 text-2xl absolute -top-2 -left-2"></i>"Hi, I love your shop, but I noticed the entrance step makes it impossible for many people to enter. Have you heard of the StopGap Foundation? They build ramps to help businesses like yours welcome everyone."</div></div></div></div>
            </div>
            <div class="p-4 border-t border-gray-100 bg-gray-50 text-center"><button onclick="closeBeyondModal()" class="w-full px-4 py-2.5 text-sm font-bold text-slate-600 bg-white border border-gray-200 rounded-lg hover:bg-gray-100 transition-colors">Back to Map</button></div>
        </div>
    </div>

    <!-- Add Pin Modal -->
    <div id="pinModal" role="dialog" aria-modal="true" aria-labelledby="pinTitle" class="hidden absolute inset-0 z-[2000] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm animate-fade-in overflow-hidden transform transition-all focus:outline-none" tabindex="-1">
            <div class="bg-slate-800 p-4 text-white flex justify-between items-center">
                <h2 id="pinTitle" class="font-bold text-lg flex items-center gap-2"><i class="ph-bold ph-plus-circle" aria-hidden="true"></i> Log Location</h2>
                <button onclick="closeModal()" aria-label="Close modal" class="hover:bg-white/20 rounded-full p-1 transition-colors"><i class="ph-bold ph-x text-xl" aria-hidden="true"></i></button>
            </div>
            <form id="pinForm" onsubmit="handlePinSubmit(event)" class="p-6 space-y-4">
                <div class="bg-blue-50 border border-blue-100 rounded-lg p-3">
                    <button type="button" id="voiceBtn" onclick="toggleVoiceFill()" class="w-full flex items-center justify-center gap-2 text-sm font-bold text-blue-700 hover:text-blue-800 transition-colors py-1">
                        <span id="voiceIconWrapper" class="bg-blue-200 p-1.5 rounded-full transition-all"><i class="ph-fill ph-microphone text-lg"></i></span>
                        <span id="voiceBtnText">Tap to Describe with Voice</span>
                    </button>
                    <p class="text-[10px] text-blue-500 text-center mt-1">"Cat Cafe has a big step"</p>
                </div>
                <div class="relative">
                    <label for="pinName" class="block text-xs font-bold text-gray-600 uppercase mb-1">Business / Location Name</label>
                    <input type="text" id="pinName" required placeholder="e.g. The Corner Bakery" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-slate-500 focus:border-slate-500 block p-2.5 outline-none transition-all focus:bg-white">
                </div>
                <div class="relative">
                    <label for="pinDesc" class="block text-xs font-bold text-gray-600 uppercase mb-1">Accessibility Notes</label>
                    <textarea id="pinDesc" rows="2" placeholder="Is there a step? Automatic door? Ramp available?" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-slate-500 focus:border-slate-500 block p-2.5 outline-none transition-all focus:bg-white resize-none"></textarea>
                </div>
                <fieldset>
                    <legend class="block text-xs font-bold text-gray-600 uppercase mb-2">Entry Status</legend>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="cursor-pointer relative">
                            <input type="radio" name="accessibility" value="accessible" checked class="peer sr-only" onchange="updatePreviewColor('accessible')">
                            <div id="radioAccessible" class="flex flex-col items-center justify-center gap-1 p-3 bg-gray-50 border-2 border-transparent rounded-lg peer-focus:ring-2 peer-focus:ring-offset-2 peer-focus:ring-green-500 peer-checked:bg-green-50 peer-checked:border-green-600 peer-checked:text-green-800 transition-all hover:bg-gray-100 text-gray-500"><i class="ph-fill ph-check-circle text-2xl" aria-hidden="true"></i><span class="text-xs font-bold uppercase">Accessible</span></div>
                        </label>
                        <label class="cursor-pointer relative">
                            <input type="radio" name="accessibility" value="inaccessible" class="peer sr-only" onchange="updatePreviewColor('inaccessible')">
                            <div id="radioInaccessible" class="flex flex-col items-center justify-center gap-1 p-3 bg-gray-50 border-2 border-transparent rounded-lg peer-focus:ring-2 peer-focus:ring-offset-2 peer-focus:ring-red-500 peer-checked:bg-red-50 peer-checked:border-red-600 peer-checked:text-red-800 transition-all hover:bg-gray-100 text-gray-500"><i class="ph-fill ph-prohibit text-2xl" aria-hidden="true"></i><span class="text-xs font-bold uppercase">Needs Ramp</span></div>
                        </label>
                    </div>
                </fieldset>
                <input type="hidden" id="pinLat"><input type="hidden" id="pinLng">
                <div class="flex justify-center items-center gap-2 py-2 text-slate-500 text-xs" aria-hidden="true"><span>Map Icon Preview:</span><i id="iconPreview" class="ph-fill ph-map-pin text-3xl text-green-600 transition-colors duration-300"></i></div>
                <div class="pt-2 flex gap-3">
                    <button type="button" onclick="closeModal()" class="flex-1 px-4 py-2 text-sm font-bold text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">Cancel</button>
                    <button type="submit" class="flex-1 px-4 py-2 text-sm font-bold text-white bg-red-600 rounded-lg hover:bg-red-700 shadow-lg shadow-red-500/30 transition-all transform hover:-translate-y-0.5">Add to Map</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" role="dialog" aria-modal="true" aria-labelledby="deleteTitle" class="hidden absolute inset-0 z-[2000] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-xs animate-fade-in p-5 text-center focus:outline-none" tabindex="-1">
            <div class="mx-auto bg-red-100 w-12 h-12 rounded-full flex items-center justify-center mb-4" aria-hidden="true"><i class="ph-fill ph-trash text-2xl text-red-600"></i></div>
            <h3 id="deleteTitle" class="text-lg font-bold text-gray-800 mb-1">Remove Location?</h3>
            <p class="text-sm text-gray-600 mb-5">This will permanently remove this accessibility data.</p>
            <div class="flex gap-2">
                <button onclick="closeDeleteModal()" class="flex-1 px-3 py-2 text-sm font-semibold text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">Cancel</button>
                <button onclick="confirmDelete()" class="flex-1 px-3 py-2 text-sm font-semibold text-white bg-red-600 rounded-lg hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" role="status" aria-live="polite" class="fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-xl z-[2000] text-sm font-medium opacity-0 pointer-events-none transition-opacity duration-300 flex items-center gap-2">
        <i class="ph-fill ph-check-circle text-green-400 text-lg" aria-hidden="true"></i>
        <span id="toastMsg">Location added!</span>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, updateDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const _g = "QUl6YVN5Qng4UF9CMkY2NTdyZVBrNFpEWU9ERE9Td3VVeVZKZ09z";
        const _f = "QUl6YVN5RFNQdU1RQjJ3VWk2MUNwdTNMVWtGa0xpMko1SDdnaEFR";
        const gToken = atob(_g);
        const firebaseConfig = { apiKey: atob(_f), authDomain: "stop-c765a.firebaseapp.com", projectId: "stop-c765a", storageBucket: "stop-c765a.firebasestorage.app", messagingSenderId: "1072607234612", appId: "1:1072607234612:web:888077d556642dc88ed861", measurementId: "G-QWHTHCCM1R" };

        let db, auth, currentUser;
        let map, markers = {}, tempMarker = null, pinToDelete = null, lastFocusedElement = null;
        let recognition = null;
        let isListening = false;
        let toastTimeout;
        let currentTranscript = "";
        let currentFilter = 'all'; // Default Filter
        let allPinsData = {}; // Store raw pin data locally
        let searchMarker = null; // Add this
        let isProcessing = false; // Voice lock

        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            initAuth();
        } catch (e) {
            console.error("Firebase init error:", e);
        }

        document.addEventListener('DOMContentLoaded', () => { initMap(); });

        async function initAuth() {
            onAuthStateChanged(auth, (user) => { if (user) { currentUser = user; subscribeToPins(); } else { currentUser = null; } });
            try { await signInAnonymously(auth); } catch (error) { console.error("Auth failed:", error); }
        }

        // --- NEW: Filter Logic ---
        window.setFilter = function(filterType) {
            currentFilter = filterType;

            // UI Updates
            ['all', 'accessible', 'inaccessible'].forEach(t => {
                const btn = document.getElementById(`filter-${t}`);
                if (t === filterType) {
                    btn.className = "flex-1 px-3 py-1.5 rounded-lg text-xs font-bold bg-slate-900 text-white transition-colors text-center shadow-sm";
                } else {
                    btn.className = "flex-1 px-3 py-1.5 rounded-lg text-xs font-bold text-slate-600 hover:bg-slate-100 transition-colors flex items-center justify-center gap-1";
                }
            });

            refreshMarkers();
        };

        function refreshMarkers() {
            // Clear current map layers
            Object.values(markers).forEach(m => map.removeLayer(m));
            markers = {}; // Clear reference

            // Re-add based on filter
            Object.values(allPinsData).forEach(pin => {
                if (currentFilter === 'all' || pin.accessibility === currentFilter) {
                    addPinToMap(pin);
                }
            });
        }

        function subscribeToPins() {
            if (!currentUser) return;
            const pinsCollection = collection(db, 'pins');
            onSnapshot(pinsCollection, (snapshot) => {
                const currentIds = [];
                snapshot.forEach((doc) => {
                    const pinData = { id: doc.id, ...doc.data() };
                    currentIds.push(pinData.id);
                    allPinsData[pinData.id] = pinData; // Update local store
                });

                // Remove deleted pins from local store
                Object.keys(allPinsData).forEach(id => {
                    if (!currentIds.includes(id)) {
                        delete allPinsData[id];
                    }
                });

                refreshMarkers(); // Redraw map
            });
        }

        // --- NEW: Search Logic ---

        // 1. Separate logic so it can be called by Enter key OR Button click
        window.performSearch = async function() {
            const query = document.getElementById('searchInput').value;
            if (!query) return;

            try {
                // Using Nominatim (OpenStreetMap)
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&viewbox=-80.10,44.30,-78.50,43.10&bounded=1`);
                const data = await response.json();

                if (data && data.length > 0) {
                    const { lat, lon } = data[0];

                    // Remove previous search marker if exists
                    if (searchMarker) {
                        map.removeLayer(searchMarker);
                    }

                    // Add new circle marker
                    searchMarker = L.circleMarker([lat, lon], {
                        radius: 10,
                        fillColor: "#3b82f6", // Blue
                        color: "#ffffff",     // White border
                        weight: 3,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);

                    map.flyTo([lat, lon], 16);
                    showToast(`Found: ${data[0].display_name.split(',')[0]}`);
                } else {
                    showToast("Location not found in GTA");
                }
            } catch (err) {
                console.error("Search error:", err);
                showToast("Search failed");
            }
        }

        // 2. Keyboard handler (calls logic if key is Enter)
        window.handleSearchKey = function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        };

        // --- NEW: Find My Location ---
        window.locateUser = function() {
            if (!navigator.geolocation) {
                showToast("Geolocation not supported");
                return;
            }

            showToast("Locating...");

            map.locate({setView: true, maxZoom: 16});

            map.once('locationfound', (e) => {
                 L.circle(e.latlng, {
                    color: '#2563eb',
                    fillColor: '#3b82f6',
                    fillOpacity: 0.2,
                    radius: e.accuracy / 2
                }).addTo(map);
                showToast("You are here");
            });

            map.once('locationerror', (e) => {
                showToast("Could not find location");
            });
        };

        function initMap() {
            const DEFAULT_VIEW = [43.6532, -79.3832];
            const GTA_BOUNDS = L.latLngBounds([43.10, -80.10], [44.30, -78.50]);
            const googleStreets = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', { maxZoom: 20, subdomains: ['mt0','mt1','mt2','mt3'], attribution: '&copy; Google' });
            const googleHybrid = L.tileLayer('http://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', { maxZoom: 20, subdomains: ['mt0','mt1','mt2','mt3'], attribution: '&copy; Google' });

            map = L.map('map', { zoomControl: false, layers: [googleStreets], maxBounds: GTA_BOUNDS, maxBoundsViscosity: 1.0, minZoom: 9 }).setView(DEFAULT_VIEW, 13);
            L.control.layers({ "Map": googleStreets, "Satellite": googleHybrid }, null, { position: 'topright' }).addTo(map);
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            map.on('click', onMapClick);
        }

        function onMapClick(e) {
            if (tempMarker) map.removeLayer(tempMarker);
            const tempIcon = L.divIcon({ className: 'custom-pin', html: `<i class="ph-fill ph-map-pin text-4xl text-slate-400 animate-bounce"></i>`, iconSize: [32, 32], iconAnchor: [16, 32] });
            tempMarker = L.marker([e.latlng.lat, e.latlng.lng], { icon: tempIcon }).addTo(map);
            openModal(e.latlng.lat, e.latlng.lng);
        }

        function addPinToMap(pin) {
            const colorClass = pin.accessibility === 'accessible' ? 'text-green-600' : 'text-red-600';
            const customIcon = L.divIcon({ className: 'custom-pin', html: `<i class="ph-fill ph-map-pin text-4xl ${colorClass} pin-marker"></i>`, iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -32] });
            const marker = L.marker([pin.lat, pin.lng], { icon: customIcon }).addTo(map);
            marker.bindPopup(createPopupContent(pin));
            markers[pin.id] = marker;
        }

        function updateMarkerPopup(pin) {
            const marker = markers[pin.id];
            if (marker) marker.setPopupContent(createPopupContent(pin));
        }

        function createPopupContent(pin) {
            const upvotes = pin.upvotes || 0;
            const downvotes = pin.downvotes || 0;
            const isCreator = currentUser && pin.creatorId === currentUser.uid;
            const isAccessible = pin.accessibility === 'accessible';
            const colorClass = isAccessible ? 'text-green-700' : 'text-red-700';
            const statusText = isAccessible ? 'Accessible' : 'Needs Ramp';
            const statusIcon = isAccessible ? 'ph-check-circle' : 'ph-warning';
            const myVoteKey = `vote_${pin.id}`;
            const myVote = localStorage.getItem(myVoteKey);
            const upClass = myVote === 'up' ? 'bg-green-100 text-green-800 border border-green-300' : 'bg-white text-slate-700 hover:bg-green-50 hover:text-green-800 border border-transparent shadow-sm';
            const downClass = myVote === 'down' ? 'bg-red-100 text-red-800 border border-red-300' : 'bg-white text-slate-700 hover:bg-red-50 hover:text-red-800 border border-transparent shadow-sm';

            return `
                <div class="font-sans text-slate-700 select-none">
                    <div class="bg-slate-50 p-3 border-b border-gray-200 flex items-center justify-between">
                        <div class="flex items-center gap-2"><i class="ph-fill ph-map-pin ${colorClass} text-lg"></i><h3 class="font-bold text-md text-slate-900 leading-tight">${escapeHtml(pin.name)}</h3></div>
                    </div>
                    <div class="px-3 pt-2 pb-1">
                        <div class="flex items-center gap-1.5 text-xs font-bold uppercase tracking-wider mb-2 ${colorClass}"><i class="ph-fill ${statusIcon}"></i> ${statusText}</div>
                        <p class="text-sm text-gray-700 mb-4 leading-relaxed">${escapeHtml(pin.desc) || "No description."}</p>
                        <div class="flex items-center justify-between bg-slate-100 rounded-lg p-1.5 mb-3">
                            <div class="flex gap-1">
                                <button onclick="window.handleVote('${pin.id}', 'up')" class="flex items-center gap-1 px-2 py-1 rounded transition-colors text-xs font-bold ${upClass}" title="Helpful"><i class="ph-bold ph-thumbs-up"></i> ${upvotes}</button>
                                <button onclick="window.handleVote('${pin.id}', 'down')" class="flex items-center gap-1 px-2 py-1 rounded transition-colors text-xs font-bold ${downClass}" title="Not Helpful"><i class="ph-bold ph-thumbs-down"></i> ${downvotes}</button>
                            </div>
                            ${isCreator ? `<button onclick="window.initDelete('${pin.id}')" class="text-xs text-red-600 hover:text-red-800 hover:bg-red-50 p-1 rounded transition-colors" title="Delete"><i class="ph-bold ph-trash text-lg"></i></button>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

// --- Voice AI Logic ---
let silenceTimer;

window.toggleVoiceFill = function() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert("Voice input is not supported in this browser.");
        return;
    }

    const btnText = document.getElementById('voiceBtnText');
    const iconWrapper = document.getElementById('voiceIconWrapper');
    const btn = document.getElementById('voiceBtn');

    // 1. STOP Logic (Manual Stop)
    if (isListening) {
        if (recognition) recognition.stop();
        // The onend handler will take care of processing
        return;
    }

    // 2. START Logic
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();

    // Check for Android (Chrome) to fix the repetition bug
    const isAndroid = /Android/i.test(navigator.userAgent);

    recognition.lang = 'en-US';

    // BUG FIX: On Android Chrome, interimResults=true causes duplication/garbage text.
    // We disable it on Android so text only appears when "final" (chunks), preventing the bug.
    recognition.interimResults = !isAndroid;

    // Keep continuous=true for the 3-second pause feature
    recognition.continuous = true;
    recognition.maxAlternatives = 1;

    isListening = true;
    isProcessing = false;
    currentTranscript = "";

    // UI Updates
    btnText.innerText = "Listening... (Tap to Finish)";
    btn.classList.remove('text-blue-700');
    btn.classList.add('text-red-600', 'animate-pulse');
    iconWrapper.classList.remove('bg-blue-200');
    iconWrapper.classList.add('bg-red-100', 'animate-pulse-ring');

    recognition.start();

    // Helper to trigger processing safely
    const triggerProcessing = async () => {
        if (isProcessing || !currentTranscript.trim()) {
            resetVoiceUI();
            return;
        }

        isProcessing = true; // Lock
        isListening = false;
        if (silenceTimer) clearTimeout(silenceTimer);

        btnText.innerText = "Processing...";
        await processWithGemini(currentTranscript);
        resetVoiceUI();
    };

    recognition.onresult = (event) => {
        if (silenceTimer) clearTimeout(silenceTimer);

        // Rebuild transcript from all segments (essential for continuous mode)
        let fullTranscript = "";
        for (let i = 0; i < event.results.length; ++i) {
            fullTranscript += event.results[i][0].transcript;
        }
        currentTranscript = fullTranscript;

        if (fullTranscript) {
            const display = fullTranscript.length > 30 ? "..." + fullTranscript.slice(-30) : fullTranscript;
            btnText.innerText = `"${display}..."`;
        }

        // CHANGED: Increased timeout to 3000ms (3 seconds) of silence
        silenceTimer = setTimeout(() => {
            recognition.stop();
        }, 3000);
    };

    recognition.onerror = (event) => {
        // If 'aborted' happens but we have text, process it (common on mobile)
        if (event.error === 'aborted' && currentTranscript.trim().length > 0) {
            recognition.stop();
            return;
        }

        if (event.error === 'no-speech') return;

        console.warn("Voice error:", event.error);
        if (!currentTranscript.trim()) {
            showToast("Microphone error. Try typing.");
        }
    };

    recognition.onend = () => {
        // If the browser cuts the connection (even before our timer),
        // we still process whatever text we captured.
        if (currentTranscript.trim().length > 0 && !isProcessing) {
            triggerProcessing();
        } else {
            resetVoiceUI();
        }
    };
};

        function resetVoiceUI() {
            const btn = document.getElementById('voiceBtn');
            const iconWrapper = document.getElementById('voiceIconWrapper');
            const btnText = document.getElementById('voiceBtnText');

            if (silenceTimer) clearTimeout(silenceTimer);

            btnText.innerText = "Tap to Describe with Voice";
            btn.classList.add('text-blue-700');
            btn.classList.remove('text-red-600', 'animate-pulse');
            iconWrapper.classList.remove('bg-red-100', 'animate-pulse-ring');
            iconWrapper.classList.add('bg-blue-200');
            isListening = false;
            isProcessing = false; // Unlock
        }

        async function processWithGemini(transcript) {
            try {
                const systemPrompt = `
                    You are a data extractor. Extract 3 fields from the user's spoken description of a location:
                    1. "name": The business name (Capitalized).
                    2. "desc": A short description of the accessibility features/barriers.
                    3. "accessibility": Either "accessible" (if they mention ramps, auto doors, no steps) or "inaccessible" (if they mention steps, stairs, heavy doors).
                    4. Sometimes the transcript will not be 100% accurate, such as getting similar sounding words mixed up, in those situations try your best to guess their intent.
                    Return ONLY valid JSON.
                `;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${gToken}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Description: "${transcript}"` }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error("AI Error Details:", errorData);
                    throw new Error(`AI Request failed: ${response.status} ${errorData.error?.message || ''}`);
                }

                const data = await response.json();
                const result = JSON.parse(data.candidates[0].content.parts[0].text);

                // Populate Fields
                document.getElementById('pinName').value = result.name || "";
                document.getElementById('pinDesc').value = result.desc || "";

                // Set Radio Button
                const radioValue = result.accessibility === 'accessible' ? 'accessible' : 'inaccessible';
                document.querySelector(`input[name="accessibility"][value="${radioValue}"]`).checked = true;
                window.updatePreviewColor(radioValue);

                showToast("Auto-filled from voice!");

            } catch (error) {
                console.error("AI processing error:", error);
                document.getElementById('pinDesc').value = transcript; // Fallback: just put text in description
                showToast("Couldn't process structure, but text added.");
            } finally {
                // Ensure UI resets even if AI fails
                isProcessing = false;
            }
        }

        // --- Standard Handlers (Vote, Delete, Submit, Modals) ---
        window.handleVote = async function(pinId, type) { if (!currentUser) return showToast("Offline mode"); const storageKey = `vote_${pinId}`; const previousVote = localStorage.getItem(storageKey); const pinRef = doc(db, 'pins', pinId); try { if (previousVote === type) { await updateDoc(pinRef, type === 'up' ? { upvotes: increment(-1) } : { downvotes: increment(-1) }); localStorage.removeItem(storageKey); } else { const update = {}; if (previousVote) update[previousVote === 'up' ? 'upvotes' : 'downvotes'] = increment(-1); update[type === 'up' ? 'upvotes' : 'downvotes'] = increment(1); await updateDoc(pinRef, update); localStorage.setItem(storageKey, type); } showToast("Voted!"); } catch (err) { console.error("Vote failed", err); } };
        window.initDelete = function(id) { if (!currentUser) return; pinToDelete = id; openModalById('deleteModal'); };
        window.closeDeleteModal = function() { pinToDelete = null; closeModalById('deleteModal'); };
        window.confirmDelete = async function() {
            if (!currentUser || !pinToDelete) return;
            const btn = document.querySelector('#deleteModal button.bg-red-600');
            const originalText = btn.innerText;
            btn.innerText = "Deleting..."; btn.disabled = true;
            try { await deleteDoc(doc(db, 'pins', pinToDelete)); showToast("Location removed"); closeDeleteModal(); }
            catch (err) { console.error("Delete failed:", err); showToast("Could not delete"); } finally { btn.innerText = originalText; btn.disabled = false; }
        };

        window.handlePinSubmit = async function(e) {
            e.preventDefault();
            if (!currentUser) { showToast("Wait for connection..."); return; }
            const name = document.getElementById('pinName').value;
            const desc = document.getElementById('pinDesc').value;
            const lat = parseFloat(document.getElementById('pinLat').value);
            const lng = parseFloat(document.getElementById('pinLng').value);
            const accessibility = document.querySelector('input[name="accessibility"]:checked').value;
            if (!name) return;
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerText; submitBtn.innerText = "Adding..."; submitBtn.disabled = true;
            try {
                await addDoc(collection(db, 'pins'), { name, desc, lat, lng, accessibility, upvotes: 0, downvotes: 0, creatorId: currentUser.uid, createdAt: new Date().toISOString() });
                if (tempMarker) map.removeLayer(tempMarker); closeModal(); showToast("Location added!"); document.getElementById('pinForm').reset();
            } catch (err) { console.error("Error adding pin:", err); showToast("Error adding location"); } finally { submitBtn.innerText = originalText; submitBtn.disabled = false; }
        };

        // --- Utils & Focus Management ---
        function trapFocus(modal) {
            const focusableElements = modal.querySelectorAll('a[href], area[href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), button:not([disabled]), iframe, object, embed, [tabindex="0"], [contenteditable]');
            const first = focusableElements[0]; const last = focusableElements[focusableElements.length - 1];
            modal.addEventListener('keydown', function(e) {
                if (e.key === 'Tab') {
                    if (e.shiftKey) { if (document.activeElement === first) { e.preventDefault(); last.focus(); } }
                    else { if (document.activeElement === last) { e.preventDefault(); first.focus(); } }
                }
                if (e.key === 'Escape') closeModalById(modal.id);
            });
        }
        function openModalById(modalId) { lastFocusedElement = document.activeElement; const modal = document.getElementById(modalId); modal.classList.remove('hidden'); modal.focus(); trapFocus(modal); }
        function closeModalById(modalId) { const modal = document.getElementById(modalId); modal.classList.add('hidden'); if (lastFocusedElement) lastFocusedElement.focus(); }

        window.openModal = function(lat, lng) { document.getElementById('pinLat').value = lat; document.getElementById('pinLng').value = lng; window.updatePreviewColor('accessible'); document.querySelector('input[value="accessible"]').checked = true; openModalById('pinModal'); };
        window.closeModal = function() { closeModalById('pinModal'); if (tempMarker) map.removeLayer(tempMarker); };
        window.openAboutModal = () => openModalById('aboutModal'); window.closeAboutModal = () => closeModalById('aboutModal');
        window.openHelpModal = () => openModalById('helpModal'); window.closeHelpModal = () => closeModalById('helpModal');
        window.openBeyondModal = () => openModalById('beyondModal'); window.closeBeyondModal = () => closeModalById('beyondModal');
        window.updatePreviewColor = function(status) { const preview = document.getElementById('iconPreview'); preview.className = status === 'accessible' ? "ph-fill ph-map-pin text-3xl text-green-600 transition-colors duration-300" : "ph-fill ph-map-pin text-3xl text-red-600 transition-colors duration-300"; };
        window.showToast = function(message) { const toast = document.getElementById('toast'); document.getElementById('toastMsg').innerText = message; toast.classList.remove('opacity-0'); if (toastTimeout) clearTimeout(toastTimeout); toastTimeout = setTimeout(() => { toast.classList.add('opacity-0'); }, 3000); };
        function escapeHtml(text) { if (!text) return ""; return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;"); }
    </script>
</body>
</html>
